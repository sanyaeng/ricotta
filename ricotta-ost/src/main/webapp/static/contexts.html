<div class="contexts">
	<table class="table table-striped table-bordered">
        <thead>
			<tr>
				<th><span class="icon-trash icon-black" /></th>
	            <th><span class="icon-hdd icon-black" /></th>
				<th>Context Name</th>
				<th>Description</th>
			</tr>
		</thead>
        <tbody id="contextsListBody" class="ricotta-text-small"></tbody>
        <tfoot>
        </tfoot>
        
    </table>
	
	<a id="buttonAddContext" data-toggle="modal" href="#createContextDialog" class="btn btn-primary">Add new context...</a>
	
	<div id="createContextDialog" class="modal fade hide">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">Ã—</a>
			<h3>Create new context</h3>
		</div>
		<div class="modal-body">
			<div class="alert alert-error hide">
  				<strong>Error! </strong><span class="validateTips"></span>
			</div>  
			<div>
				<label class="modal-label" for="contextName">Context Name</label>
				<input type="text" class="modal-text" name="contextName" id="contextName" value="">
			</div>
			<div class="divider horiziontal-divider"></div>
			<div>
				<label class="modal-label" for="contextDescription">Context Description</label>
				<input type="text" class="modal-text" name="contextDescription" id="contextDescription" value="">
			</div>
			<div class="divider horiziontal-divider></div>
			<div>
				<input type="hidden" id="contextImgKey" value="">
				<form action="" id="uploadContextImage" method="POST" enctype="multipart/form-data">
					<label class="modal-label">Context Image</label>
					<input type="file" id="contextImage" name="contextImage">
				</form>
				<!-- <a class="btn" id="uploadImage" onclick="uploadImage();" disabled="disabled">Upload Context Image...</a><span id="ajaxloader"></span> -->
			</div>
		</div>
		<div class="modal-footer">
			<a class="btn btn-success btn-create" >Create Context</a>
		</div>
	</div>
	<script type="text/javascript">
	
	function updateUser(id, role) {
	    // find this user in data
	    var p = $("#headerProject").data("project");
	    $.map(p.users, function(t, i) {
	        if (t.keyString == id) {
	            t.role = role;
	            return;
	        }
	    });
	}
	
	/**
	 * Update new after save success
	 */
	function updateNewUser(id, role) {
		updateUser(id, body.role);
	    clearChanged(id);
	    hideToast();
	}
	
	function saveUser(id) {
	    showToast('Saving user role...');
	    var p = $("#headerProject").data("project");
	    
	    var body = {
	        role: $("#role_" + id).val()
	    };
	   	ricottaAPI.saveUser(p.name, id, function(d){
	   		updateNewUser(id, body.role);
	   	}, showToast);
	}
	
	function setChanged(id) {
	    $("#delete_" + id).hide();
	    $("#save_" + id).show();
	}
	
	function clearChanged(id) {
	    $("#delete_" + id).show();
	    $("#save_" + id).hide();
	}
	
	function buildContextsTable(p) {
		$("#contextsListBody").empty();
	    $.map(p.contexts, function(t, index) {
	        var id = t.keyString;
	        $("#contextsListBody").append($('<tr id="context_' + index + '"></tr>'));
	        
	        // icons
	        $("#context_" + index).append('<td>' +
	            '<span id="delete_' + id + '" class="icon-trash icon-black" onClick="deleteContext(\'' + id + '\');">Delete</span>' +
	            '</td>');
	        $("#context_" + index).append('<td>' +
	            '<span id="save_' + id + '" class="icon-hdd icon-black" onClick="saveContext(\'' + id + '\');" style="display: none">Update</span>' +
	            '</td>');
	
	        $("#context_" + index).append('<td>' + t.name + '</td>');
	        $("#context_" + index).append('<td><input type="text" id="description_' + id + '" onChange="setChanged(\'' + id + '\');" value="' + t.description + '" /></td>');
	    });
	}
	
	function deleteContext(keyString) {
		var p = $("#headerProject").data("project");
		ricottaAPI.deleteContext(p.name, keyString, function(){
			loadProjectTokens(p.name);
			buildContextsTable($("#headerProject").data("project"));
			if(typeof refreshToken === 'function') {
    			refreshToken();
    		}
		}, function(){});
	}
	function uploadImage() {
		var p = $("#headerProject").data("project");
		ricottaAPI.uploadContextImage(p.name, function(blob){
	    	var url = blob.uploadUrl.replace("GGPP", "localhost");
	    	$("#uploadContextImage").attr("action", url);
	    	$("#uploadContextImage").submit();
	    });
	}
	
	$(function() {
		$("#buttonAddContext").click(function(){
			$(".alert-error").removeClass("show").addClass("hide");
			var ctxName = $("#contextName");
	        var ctxDescription = $("#contextDescription");
	        var ctxKey = $("#contextImgKey");
	        var allFields = $([]).add(ctxName);
	        allFields.removeClass("input_error");
		});
	    $("#createContextDialog").modal({show: false});
	    var p = $("#headerProject").data("project");
	    $(".btn-success").click(function(){
	    	 var ctxName = $("#contextName"),
	          ctxDescription = $("#contextDescription"),
	          ctxKey = $("#contextImgKey"),
	          allFields = $([]).add(ctxName),
	          tips = $(".validateTips");
	
		      var bValid = true;
		      allFields.removeClass("ui-state-error");
		      bValid = bValid && checkEmpty(allFields);
		      
		      if(bValid) {
		    	  	/**
		    	  	 * if the context image is added, the image needs to be upload first the set the blob key to the context object after upload success.
		    	  	 * otherwise, will upload without image
		    	  	 */ 
		    		if($("#contextImage").val() != "") {
			    	 	uploadImage();
		    		}
		    		else {
		    			createNewContext(p);
		    		}
			  }
		});
	    $('#uploadContextImage').iframePostForm({
			json : true,
			complete : function (blob) {
				$("#contextImgKey").val(blob.blobKey);
				createNewContext(p);
			}
		});
	    
	    buildContextsTable(p);
	    if(typeof refreshToken === 'function') {
			refreshToken();
		}
	    $("#createContextDialog").modal("hide");
	});
	
	function createNewContext(p) {
		var data = {
    		"name": $("#contextName").val(),
    		"description": $("#contextDescription").val(),
    		"blobKey": $("#contextImgKey").val(),
    	};
    	ricottaAPI.createContext(p.name, data, function(){
    		loadProjectTokens(p.name);
    		buildContextsTable($("#headerProject").data("project"));
    		//refreshProjectContent("tokens");
    		if(typeof refreshToken === 'function') {
    			refreshToken();
    		}
    		$("#createContextDialog").modal("hide");
    	});
	}
	</script>
	
</div>
