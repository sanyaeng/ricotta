<div class="project">
	<div class="row-fluid">
		<div class="span2">
			<div class="well sidebar-nav project-title">
				<ul class="nav nav-list">
					<li style="cursor:pointer;" onclick="reloadGeneralSetting();">
						<span id="projectname"></span>
					</li>
				</ul>
			</div>
			<div class="translation-sidebar">
				<div class="translation-title nav-list">
					<span>Translation</span>
				</div>
				<div class="translation-body">
					<div id="selectedToken"></div>
					<div class="context-filter">
						<label for="contextFilter">Filter by context</label>
						<select id="contextFilter" onchange="tokenFiltered();"></select>
					</div>
					<div class="completion-filter">
						<label for="completionFilter">Filter by completion</label>
						<select id="completionFilter" onchange="tokenFiltered();"></select>
					</div>
					<div class="token-wrapper">
						<ul id="translationToken"></ul>
					</div>
				</div>
				<div class="translation-footer">
					<a id="addTranslation" class="btn btn-small btn-primary" data-toggle="modal" href="#createTokenDialog">Add String</a>
				</div>
			</div>
		</div>
		<div class="divider vertical-divider"></div>
		<div class="span10">
			<div class="nav">
				<div><span class="selected" data-target="generalSetting">General</span></div>
				<div><span data-target="contexts">Upload Screenshots</span></div>
				<div><span data-target="tokens">String Manger</span></div>
			</div>
			<div id="projectSetting">
			</div>
		</div>
	</div>
	<!-- Create Token Dialog should be global -->
	<div id="createTokenDialog" class="modal hide fade in" style="display: none;">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">Ã—</a>
			<h3>Create new token</h3>
		</div> 
		<div class="modal-body">
			<p class="validateTips"></p>
		    <form>
		        <div>
		            <label class="modal-label" for="toknName">Token name</label>
		            <input class="modal-input" type="text" id="toknName" name="toknName"/><br/>
		        </div>
		        <div class="divider horiziontal-divider"></div>
		        <div>
		            <label class="modal-label" for="toknDescription">Description</label>
		            <input class="modal-input" type="text" id="toknDescription" name="toknDescription"/><br/>
		        </div>
		        <div class="divider horiziontal-divider"></div>
		        <div>
		            <label class="modal-label" for="toknContext">Context</label>
		            <select class="modal-input" id="toknContext" ><option value="_NO_CONTEXT_">_NO_CONTEXT_</option></select>
		        </div>
		    </form>
		</div>
		<div class="modal-footer">
			<a class="btn btn-success btn-create">Create Token</a>
		</div>
	</div>
</div>
<script type="text/javascript">
function reloadGeneralSetting() {
	setProjectActiveMenu($('.span10 > .nav span:first'));
	$('.span10 > .nav').removeClass('hide');
	loadProjectContent('generalSetting');
}
function tokenFiltered() {
	$("#translationToken").children().each(function(){
		$(this).show();
		if(($(this).data("context") != $("#contextFilter option:selected").val() 
			&& $("#contextFilter option:selected").val() != "-1") 
			|| ($.inArray($("#completionFilter option:selected").val(), $(this).data("uncompletTranslation")) < 0 
					&& $("#completionFilter option:selected").val() != "-1")) {
			$(this).hide();
		}
	});
}
function loadProjectTokens(pname) {
    ricottaAPI.getProjectTokens(pname, function(data){
        $("#headerProject").data("project", data);
    }, showToast);
}

function updateVerticalDivider() {
	$(".vertical-divider").css("height", $(window).height() + "px");
	
	if($("body").height() > $(window).height()) {
		$(".vertical-divider").css("height", $("body").height() + "px");
	}
}
function setProjectActiveMenu(selectedMenu) {
	$(".span10 > .nav > div > span.selected").removeAttr("class");
	selectedMenu.attr("class", "selected");
}

function setOverMenu() {
	$(".span10 > .nav > div span.selected").addClass("selected-over");
}
function setCurrentMenuState() {
	$(".span10 > .nav > div span.selected").removeClass("selected-over");
}
function appendUncompletTranslationFilter(p) {
	$("#completionFilter").empty();
	$("#completionFilter").append("<option value='-1'>Show all</option><option value='0'>Show all uncomplete</option>");
	$.map(p.projLangs, function(l, i) {
		$("#completionFilter").append("<option value='"+l.langCode+"'>"+l.langCode +" (Uncompleted)</option>");
	});
}
function appendTranslationContextFilter() {
	$("#contextFilter").empty();
	var p = $("#headerProject").data("project");
	$("#contextFilter").append("<option value='-1'>Show all</option>");
	$.map(p.contexts, function(context, i){
		$("#contextFilter").append("<option value='"+ context.name +"'>"+ context.name +"</option>");
	});
}
function appendTranslationTokens() {
	$("#translationToken").empty();
	var p = $("#headerProject").data("project");
	$.map(p.tokens, function(token, i) {
		var uncompleteTrans = token.completeTranslation;
		var label = token.description == ''? token.name : token.description;
		$("#translationToken").append("<li id='trans_token_"+i+"' data-context='"+token.context+"'><input onclick=\"loadTranslation('"+token.id+"')\" type='radio' name='token' id='radio"+token.id+"' value='"+token.id+"'>"+
										   "<label for='radio"+token.id+"'>" + label +"</label>"+
									   "</li>");
		
		$("#trans_token_"+i).data("uncompletTranslation", getUncompleteTranslation(p.projLangs, token.completedTranslation));
	});
}

function getUncompleteTranslation(projLangs, completedTranslation) {
	var unCompleteTranslation = $([]).add(0);
	$.map(projLangs, function(l, i){
		if(completedTranslation.indexOf(l.langCode) < 0) {
			unCompleteTranslation.push(l.langCode);
		}
	});
	return unCompleteTranslation;
}
function loadTranslation(tokenId) {
	$(".span10 > .nav").addClass("hide");
	$("#selectedToken").data("tokenId", tokenId);
	if(!$(".translations").is(":visible")) {
		loadProjectContent("translations");
	}
	else {
		refreshTranslation();
		if(!$("#successMessage").parent().hasClass("hide")) {
			$("#successMessage").parent().addClass("hide");
		}
	}
	if(typeof disableCancel === 'function') {
		disableCancel();
	}
}
function createToken() {
	var p = $("#headerProject").data("project");
	$("#createTokenDialog .validateTips").text("");
      var toknName = $("#toknName"),
          toknDescription = $("#toknDescription"),
          toknContext = $("#toknContext"),
          allFields = $([]).add(toknName, toknDescription, toknContext),
          tips = $(".validateTips");

      var bValid = true;
      allFields.removeClass("ui-state-error");
      bValid = bValid && checkLength(toknName, "token name", 1, 64);

      if (bValid) {
      	var data= {
              name: toknName.val(),
              description: toknDescription.val(),
              context: toknContext.val()
          };
      	
      	ricottaAPI.createToken(p.name, data, function(newToken){
      		loadProjectTokens(p.name);
      		if($(".tokens").length > 0) {
	      		updateTokenTable(p, newToken);
	      		//destroy the table data and re-init
	      		if(tokenTable != undefined) {
		      		tokenTable.fnDestroy();
	      		}
	      		
	      		tokenTable = $("#tableToken").dataTable();
	    	    $("#tableToken_filter input").keyup(function(){
	    	    	tokenTable.fnFilter($(this).val(), 0, false, false);
	    	    });
      		}
      		appendTranslationTokens();
      		
      	}, updateTips);
      }
      $("#createTokenDialog").modal("hide");
}

function refreshSideBar() {
	
}

$(function() {
    var p = $("#headerProject").data("project");
    $("#projectname").text(p.name);
    loadProjectTokens(p.name);
    loadProjectContent("generalSetting");
    $(".span10 span").bind("click", function(){
    	loadProjectContent($(this).data("target"));
    });
    updateVerticalDivider();
    $(".span10 > .nav > div > span").bind("click", function(){
    	updateVerticalDivider();
    	setProjectActiveMenu($(this));
    });
    $(".span10 > .nav > div > span").bind("mouseover", function(){
    	setOverMenu();
    });
    $(".span10 > .nav > div > span").bind("mouseout", function(){
    	setCurrentMenuState();
    });
    /*
    $("#addTranslation").bind("click", function(){
    	addTranslation();
    });*/
    $("#createTokenDialog").find("a.btn-success").click(function(){
		createToken();
	});
    appendUncompletTranslationFilter(p);
    appendTranslationContextFilter();
    appendTranslationTokens();
});

</script>
