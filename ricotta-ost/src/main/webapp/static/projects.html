<div class="projects">
	<div> <h1>Projects </h1></div>
	<a data-toggle="modal" href="#createProjectDialog" class="btn btn-primary">Create new project...</a>
	<div id="projects"></div>
	
	<!-- using modal instead  -->
	<div id="createProjectDialog" class="modal hide fade in" style="display: none;">
		<div class="modal-header">  
			<a class="close" data-dismiss="modal">×</a>
			<h3>Create a project</h3>
		</div> 
		<div class="modal-body">
			<div class="alert alert-error hide">  
  				<a class="close" data-dismiss="alert">×</a>
  				<p class="validateTips"></p>
			</div> 
		    <form>
		    	<div class="createProjectContent">
			        <div class="box">
			            <label class="modal-label" id="pnameLabel"> Name</label>
			            <input class="modal-input" id="projName" name="projName"  type="text"/>
			        </div>
		    	</div>
		        <div class="divider horiziontal-divider"></div>
		        <div class="createProjectContent">
			        <div class="box">
			        	<label class="modal-label" id="pDefaultLang" for="defaultLang">First Language</label>
			            <select class="modal-input" id="defaultLang"></select>
			        </div>
		        </div>
		    </form>
		</div>
		<div class="modal-footer">
			<a class="btn btn-success btn-create">Create Project</a>
		</div>
	</div>
	
	<script type="text/javascript">
	
	function populateProjects(data) {
		$("#createProjectDialog").modal("hide");
	    $("#projects").empty();
	    $.map(data, function(p, i) {
	    	$("#projects").append("<div id='projectItem"+p.name+"' class='projectsItem'>"+
	    								"<div id='item'><div class='pname' onclick=\"loadProject('"+ p.name +"')\">"+p.name+"</div>"+
	    								"<div class='plang'>"+getProjectLanguage(p)+"</div>"+
	    								"<div class='powner'>Owner: "+p.owner+"</div></div>"+
	    								"<div id='itemAction'>"+
	    									"<div onclick='exportProj(\""+p.name+"\");'><span class='item-icon export'></span><br/>Export</div>"+
	    									"<div class='delete' onclick='deleteProj(\""+p.name+"\");'><span class='item-icon delete'></span><br/>Delete</div>"+
	    								"</div>"+
	    						  "</div>");
	        $("#projectItem" + p.name).data("json", p);
	    });
	}
	
	function exportProj(projName) {
		window.location.href= "http://"+ location.host + ricottaAPI.getExportUrl(projName);
	}
	
	function deleteProj(projName) {
		ricottaAPI.deleteProj(projName, function(){refreshPageContent("projects");alert(projName + " was deleted.");}, function(status){
			if("404" == status) {
				alert("Project " + projName + " already deleted.");
			}
		});
	}
	/**
	 * Return the languages of project in strings
	 */
	function getProjectLanguage(p) {
		var lang = "";
		if(p.defProjLang) {
			lang += p.defProjLang.langCode + ", ";
		}
		$.map(p.projLangs, function(l, index) {
	        lang += l.langCode + ", ";
	    });
		return lang.substring(0, lang.length - 2);//remove the last comma
	}
	function loadProject(projectName) {
	    // copy json from table to header
	    var p = $("#projectItem" + projectName).data("json");
	    $("#headerProject").data("project", p);
	    
	    // load project contents
	   	refreshPageContent("project");
	   	loadPage("project");
	}
	
	function populateLanguage() {
		ricottaAPI.loadLanguages(function(languages) {
			$.map(languages, function(l, i){
				$("#defaultLang").append("<option value='"+ l.code +"'>" + l.name + "</option>");
			})
		});
	}
	
	$(function() {
		populateLanguage();
		
	    var projName = $("#projName"),
	        allFields = $([]).add(projName),
	        tips = $(".validateTips");
		$("#createProjectDialog").find("a.btn-success").click(function() {
			var bValid = true;
	        allFields.removeClass("ui-state-error");
	        bValid = bValid && checkLength(projName, "project name", 4, 16);

	        if (bValid) {
	        	var projectName = projName.val();
	        	var defaultLang = $("#defaultLang option:selected").val();
	        	ricottaAPI.createProject(projectName, defaultLang, populateProjects, updateTips);
	        }
		});
		$("#createProjectDialog").modal({show:false});
	   
	    //retrieve all project
		ricottaAPI.getProjects(populateProjects);
	            
	});
	
	</script>
</div>
