<table id="projectTiles">
    <tbody>
        <tr>
            <td id="tileContexts" style="vertical-align: top;">
                <table id="contexts" class="ui-widget ui-widget-content">
                    <thead class="ui-widget-header">
                        <tr>
                            <th id="thContexts">Contexts</th>
                        </tr>
                    </thead>
                    <tbody id="contextsBody">
                        <tr>
                            <td>
                                <input type="radio" id="contextALL" name="context" checked="checked" value="" onChange="onContextChange(this.value);"/>
                                <label for="contextALL">All tokens</label>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </td>
            <td id="tileTokens" style="vertical-align: top;">    
                <table id="tokens" class="ui-widget ui-widget-content">
                    <thead class="ui-widget-header">
                        <tr id="tileTokensHeader">
                            <th id="thToken">Token</th>
                            <th id="thDescr">Description</th>
                            <th id="thTrans">Translation</th>
                        </tr>
                    </thead>
                    <tbody id="tokensBody" class="ricotta-text-small"></tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </td>
            <td id="tileLanguages" style="vertical-align: top;">
                <table id="languages" class="ui-widget ui-widget-content">
                    <thead class="ui-widget-header">
                        <tr>
                            <th id="thLanguages">Languages</th>
                        </tr>
                    </thead>
                    <tbody id="languagesBody">
                        <tr id="languageTRdefault">
                            <td>
                                <input type="radio" id="langDefault" name="language" checked="checked" value="" onChange="onLanguageChange(this.value);" />
                                <label id="langDefaultLabel" for="langDefault">Default</label>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </td>
        </tr>
    </tbody>
</table>

<div id="editTransDialog">
    <form>
        <input id="editTransId" name="editTransId" type="hidden" />
        <div id="editTransToken" class="text ui-widget-content ui-corner-all"></div>
        <label for="editTransDescription">Description</label>
        <br/>
        <textarea id="editTransDescription" cols="55" rows="3" name="editTransDescription"  class="text ui-widget-content ui-corner-all" readonly="readonly"></textarea>
        <br/>
        <label for="editTransTrans">Translation</label>
        <br/>
        <textarea id="editTransTrans" cols="55" rows="6" name="editTransTrans"  class="text ui-widget-content ui-corner-all" ></textarea>
        <br/>
        <label id="editTransDefaultLabel" for="editTransDefault">Default</label>
        <br/>
        <textarea id="editTransDefault" cols="55" rows="3" name="editTransDefault"  class="text ui-widget-content ui-corner-all" readonly="readonly"></textarea>
    </form>
</div>

<script type="text/javascript">

$("#editTransDialog").dialog({
    autoOpen: false,
    height: 700,
    width: 1000,
    modal: true,
    title: "Edit token translation",
    buttons: {
        Cancel: function() {
            $( this ).dialog("close");
        },
        "Update": function() {
                var p = $("#headerProject").data("json");
                var id = $("#editTransId").val();
                var code = $("#languages").data("sel");
                var t = $("#editTransTrans").val();
                $.ajax({
                        async: false,
                        type: "POST",
                        url: "/api/project/v10/" + p.name + "/token/" + id,
                        dataType: "json",
                        data: {
                            langCode: code,
                            value: t
                        }
                    })
                    .done(function(data){
                            onTokenUpdateSuccess(p, id, code, t);
                            
//                            $("#t_" + id + "_" + code).text($("#editTransTrans").val());
                            $("#editTransDialog").dialog("close");
                        })
                    .fail(function() {
                        });
        }
    }
});
    
    function appendContext(obj, index) {
        $("#contextsBody")
        .append("<tr id=\"contextTR" + obj.name + "\">")
        .append("<td><input type=\"radio\" id=\"contextCH" + obj.name + "\" name=\"context\" value=\"" + obj.name + "\" onChange=\"onContextChange(this.value);\" /><label for=\"contextCH" + obj.name + "\">"+ obj.name + "</label></td>")
        .append("</tr>");
        $("#contextTR" + obj.name).data("json", obj);
    }
    
    function onContextChange(contextName) {
        $("#contexts").data("sel", contextName);
        updateTokens();
    }
    
    function appendToken(obj, index, defProjLang, projLangs) {
        var langCode = defProjLang.langCode;
        var defLang = langCode;
        $("#tokensBody")
            .append("<tr id=\"tokenTR" + obj.id + 
                        "\" onclick=\"editTranslation('" + obj.id + "');\">" + "</tr>");
        $("#tokenTR" + obj.id).addClass("context_" + getSafe(obj.context)).addClass("token");
        $("#tokenTR" + obj.id)
            .append('<td id="t_' + obj.id + '_name" title="' + obj.name + '">' + getShort(obj.name, 20) + "</td>")
            .append('<td id="t_' + obj.id + '_description" title="' + obj.description + '">' + getShort(obj.description,20) + "</td>")
            .append('<td id="t_' + obj.id + '_' + defLang + '">' +
                (obj.trans[defLang] ? obj.trans[defLang] : '') + '</td>');
        // set the class attributes on this translation:
        $("#t_" + obj.id + "_" + defLang).addClass("lang_" + defLang).addClass("translation");

        // add additional language columns
        $.map(projLangs, function(projLang, pi){
            if (projLang.defaultLang) {
                langCode = projLang.langCode;
                $("#tokenTR" + obj.id)
                    .append("<td id=\"t_" + obj.id + "_" + langCode + 
                        "\" class=\"" + (obj.trans[langCode] ? "" : "default-trans") + 
                        "\" title=\"" + (obj.trans[defLang] ? obj.trans[defLang] : "[no default translation]") + "\">" + 
                        (obj.trans[langCode] ? obj.trans[langCode] : "") + 
                        "</td>");
                // set the class attributes on this translation:
                $("#t_" + obj.id + "_" + langCode).addClass("lang_" + langCode).addClass("translation");
            }
        });
    }
    
function onTokenUpdateSuccess(p, id, langCode, value) {
    $("#tokensBody").empty();
    $.map(p.tokens, function(t, index) {
        
        // find the updated token
        if (t.id == id) {
            
            // only update the value
            t.trans[langCode] = value;
        }
        appendToken(t, index, p.defProjLang, p.projLangs);
    });
    updateTokens();
}    
    
function editTranslation(id) {
    var defLang = $("#langDefault").val();
    var langCode = $("#languages").data("sel");

    // populate dialog fields
    $("#editTransId").val(id);
    $("#editTransToken").text($("#t_" + id + "_name").attr('title'));
    $("#editTransDescription").val($("#t_" + id + "_description").attr('title'));
    $("#editTransTrans").val($("#t_" + id + "_" + langCode).text());
    if (defLang == langCode) {
        $("#editTransDefault").hide();
        $("#editTransDefaultLabel").hide();
    }
    else {
        $("#editTransDefault").show();
        $("#editTransDefaultLabel").show();
        $("#editTransDefault").val($("#t_" + id + "_" + defLang).text());
    }

    // open dialog
    $("#editTransDialog").dialog("open");
}

    function updateTokens() {
        var context = $("#contexts").data("sel");
        if ("" == context) {
            $(".token").show();
        }
        else {
            // show selected context only
            $(".token").hide();
            $(".context_" + getSafe(context)).show();
        }
        
        // show selected language only
        var langCode = $("#languages").data("sel");
        $(".translation").hide();
        $(".lang_" + langCode).show();
    }
    
    function appendLanguage(obj, index) {
        if (obj.defaultLang) {
            $("#languagesBody")
                .append("<tr id=\"languageTR" + obj.langCode + "\"></tr>");
            $("#languageTR" + obj.langCode)
                .append("<td>" +
                "<input type=\"radio\" id=\"lang_" + obj.langCode + "\" name=\"language\" value=\"" + obj.langCode + "\" onChange=\"onLanguageChange(this.value);\" />" +
                "<label for=\"lang_" + obj.langCode + "\">"+ obj.langCode + " [" + obj.defaultLang.name + "]" + "</label>" +
                "</td>");
//            $("#languageTR" + obj.langCode).data("json", obj);
            
            $("#tileTokensHeader")
                .append('<th id="thTrans_' + obj.langCode + '">Translation (' + obj.langCode + ')</th>');
            $("#thTrans_" + obj.langCode).addClass("lang_" + obj.langCode).addClass("translation");
        }
        else {
            $("#langDefaultLabel").text(obj.langCode);
            $("#langDefault").val(obj.langCode);
            
            $("#thTrans").text("Translation (" + obj.langCode + ")");
            $("#thTrans").addClass("lang_" + obj.langCode).addClass("translation");
        }
    }
    
    function onLanguageChange(langCode) {
        $("#languages").data("sel", langCode);
        updateTokens();
    }

function buildProjectTiles(p) {
    $.map(p.contexts, function(c, index) {
        appendContext(c, index);
    });
    $.map(p.projLangs, function(l, index) {
        appendLanguage(l, index);
    });
    $.map(p.tokens, function(t, index) {
        appendToken(t, index, p.defProjLang, p.projLangs);
    });
}

$(function() {
    var p = $("#headerProject").data("json");

    $("#contexts").data("sel", "");
    $("#languages").data("sel", p.defProjLang.langCode);

    buildProjectTiles(p);
    updateTokens();
});

</script>
