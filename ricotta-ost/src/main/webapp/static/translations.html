<div class="translations" style="position:relative;">
	<div class="translation_token">
		<div id="translationTokenTitle"></div>
		<div class="alert alert-success hide">
			<a class="close" data-dismiss="alert">Ã—</a> 
			<span id="successMessage"></span>
		</div>
		<div id="languageWrapper">
			<div id="translationBody">
			</div>
			<div id="context"></div>
		</div>
	</div>
</div>
<script type="text/javascript">
    
function editTranslation(id) {
    var defLang = $("#langDefault").val();
    var langCode = $("#languages").data("sel");

    // populate dialog fields
    $("#editTransId").val(id);
    $("#editTransToken").text($("#t_" + id + "_name").attr('title'));
    $("#editTransDescription").val($("#t_" + id + "_description").attr('title'));
    $("#editTransTrans").val($("#t_" + id + "_" + langCode).text());
    if (defLang == langCode) {
        $("#editTransDefault").hide();
        $("#editTransDefaultLabel").hide();
    }
    else {
        $("#editTransDefault").show();
        $("#editTransDefaultLabel").show();
        $("#editTransDefault").val($("#t_" + id + "_" + defLang).text());
    }

    // open dialog
    //$("#editTransDialog").dialog("open");
    $("#editTransDialog").modal("show");
}

function appendLanguage(obj, index, trans) {
	var transVal = trans[obj.langCode] != undefined? trans[obj.langCode] : "";
	$("#languageWrapper > #translationBody").append("<fieldset><label for='trans_"+obj.langCode+"'>"+obj.langCode+"</label>"+
													"<textarea onchange='enableCancel();' rows='6' data-langcode='"+obj.langCode+"'type='text' id='trans_" +obj.langCode+ "'>"+ transVal +"</textarea> </fieldset>");
	
}

function enableCancel() {
	if(!$("#successMessage").parent().hasClass("hide")) {
		$("#successMessage").parent().addClass("hide");
	}
	$("#cancelTranslation").removeAttr("disabled");
	$("#cancelTranslation").removeClass("btn-disabled");
}

function disableCancel() {
	$("#cancelTranslation").attr("disabled", "disabled");
	$("#cancelTranslation").addClass("btn-disabled");
}
    
function buildContextImage(pName, blobKey,cName) {
	if(blobKey.keyString != "") {
		$("#languageWrapper > #context").append("<span class='context-title'>Context<br/><img src='/api/blob/v10/"+pName+"?key="+ blobKey.keyString + "'/></span>");
	}
	else {
		$("#languageWrapper > #context").append("<span class='context-title'>Context<br/>"+cName+"</span>");
	}
}

function buildTranslation(p, token) {
	
	$("#translationTokenTitle").append("<span class='token-title'>" + token.description +"</span>")
						  	   .append("<br/><span class='token-name'>" + token.name + "</span>");
	
	/*if(token.context) {
		
	}*/
	$.map(p.contexts, function(c, index){
		console.log(c.blobKey);
		if(c.blobKey != "" && null != c.blobKey && c.name == token.context) {
			buildContextImage(p.name, c.blobKey, c.name);
		}
	});
	$.map(p.projLangs, function(l, index){
		//$("#languageWrapper").append();
		appendLanguage(l, index, token.trans);
	});
	
	$("#languageWrapper > #translationBody").append("<div id='translationAction'><span><a onclick='addTranslation();' class='btn btn-primary'>Save</a></span><span><a onclick='refreshTranslation($(this));' class='btn btn-disabled' id='cancelTranslation' disabled='disabled'>Cancel</a></span></div>");
	
}
function showError() {
	
}
function addTranslation() {
	var p = $("#headerProject").data("project");
	var tokenId = $("#selectedToken").data("tokenId");
	var langCode = new Array(), langVal = new Array();
	$("#languageWrapper #translationBody textarea").each(function(){
		langCode.push($(this).data("langcode"));
		langVal.push($(this).val());
	});
	
	ricottaAPI.updateTranslation(langCode, langVal, p.name, tokenId, function(){
		$("#successMessage").text("Translation saved...").parent().removeClass("hide");
	}, function(){});
	
}
function refreshTranslation(btn) {
	$("#successMessage").parent().addClass("hide");
	if(btn != undefined && btn.hasClass("btn-disabled")) {
		return false;
	}
	var p = $("#headerProject").data("project");
	var tokenId = $("#selectedToken").data("tokenId");
	$("#translationTokenTitle, #translationBody, #context").empty();
	ricottaAPI.getToken(tokenId, p.name, function(token){buildTranslation(p, token)}, showError);
}
$(function() {
	$("#editTransDialog").modal({show:false});
    var p = $("#headerProject").data("project");
    //get the token with given token id and build the translation field
    var tokenId = $("#selectedToken").data("tokenId");
    $(".translation").children(":first").attr("class", "translation_token"+tokenId);
    ricottaAPI.getToken(tokenId, p.name, function(token){buildTranslation(p, token)}, showError);
    /*
    $("#contexts").data("sel", "");
    $("#languages").data("sel", p.defProjLang);

    buildProjectTiles(p);
    updateTokens();*/
});

</script>
