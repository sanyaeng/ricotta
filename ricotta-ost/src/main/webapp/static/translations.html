<table id="projectTiles">
    <tbody>
        <tr>
            <td id="tileContexts" style="vertical-align: top;">
                <table id="contexts" class="ui-widget ui-widget-content">
                    <thead class="ui-widget-header">
                        <tr>
                            <th id="thContexts">Contexts</th>
                        </tr>
                    </thead>
                    <tbody id="contextsBody">
                        <tr>
                            <td>
                                <input type="radio" id="contextALL" name="context" checked="checked" value="" onChange="onContextChange(this.value);"/>
                                <label for="contextALL">All tokens</label>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </td>
            <td id="tileTokens" style="vertical-align: top;">    
                <table id="tokens" class="ui-widget ui-widget-content">
                    <thead class="ui-widget-header">
                        <tr id="tileTokensHeader">
                            <th id="thToken">Token</th>
                            <th id="thDescr">Description</th>
                            <th id="thTrans">Translation</th>
                        </tr>
                    </thead>
                    <tbody id="tokensBody" class="ricotta-text-small"></tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </td>
            <td id="tileLanguages" style="vertical-align: top;">
                <table id="languages" class="ui-widget ui-widget-content">
                    <thead class="ui-widget-header">
                        <tr>
                            <th id="thLanguages">Languages</th>
                        </tr>
                    </thead>
                    <tbody id="languagesBody">
                        <tr id="languageTRdefault">
                            <td>
                                <input type="radio" id="langDefault" name="language" checked="checked" value="" onChange="onLanguageChange(this.value);" />
                                <label id="langDefaultLabel" for="langDefault">Default</label>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                    </tfoot>
                </table>
            </td>
        </tr>
    </tbody>
</table>
<script type="text/javascript">
    function appendContext(obj, index) {
        $("#contextsBody")
        .append("<tr id=\"contextTR" + obj.name + "\">")
        .append("<td><input type=\"radio\" id=\"contextCH" + obj.name + "\" name=\"context\" value=\"" + obj.name + "\" onChange=\"onContextChange(this.value);\" /><label for=\"contextCH" + obj.name + "\">"+ obj.name + "</label></td>")
        .append("</tr>");
        $("#contextTR" + obj.name).data("json", obj);
    }
    
    function onContextChange(contextName) {
        $("#contexts").data("sel", contextName);
        updateTokens();
    }
    
    function appendToken(obj, index, defProjLang, projLangs) {
        var langCode = defProjLang.langCode;
        var defLang = langCode;
        $("#tokensBody")
            .append("<tr id=\"tokenTR" + obj.id + "\"></tr>");
        $("#tokenTR" + obj.id).addClass("context_" + getSafe(obj.context)).addClass("token");
        $("#tokenTR" + obj.id)
            .append('<td title="' + obj.name + '">' + getShort(obj.name, 20) + "</td>")
            .append('<td title="' + obj.description + '">' + getShort(obj.description,20) + "</td>")
            .append('<td id="t_' + obj.id + '_' + defLang + '" title="' + (obj.trans[langCode] ? obj.trans[langCode] : '') + '"><pre>' + getShort(obj.trans[langCode] ? obj.trans[langCode] : '', 30) + '</pre><span class="ui-icon ui-icon-pencil" /></td>');
        // set the class attributes on this translation:
        $("#t_" + obj.id + "_" + langCode).addClass("lang_" + langCode).addClass("translation");
        $.map(projLangs, function(projLang, pi){
            if (projLang.defaultLang) {
                langCode = projLang.langCode;
                $("#tokenTR" + obj.id)
                    .append("<td id=\"t_" + obj.id + "_" + langCode + "\" class=\"" + (obj.trans[langCode] ? "" : "default-trans") + "\">" + 
                        (obj.trans[langCode] ? obj.trans[langCode] : (obj.trans[defLang] ? obj.trans[defLang] : "")) + 
                        "<span class=\"ui-icon ui-icon-pencil\" /></td>");
            }
            // set the class attributes on this translation:
            $("#t_" + obj.id + "_" + langCode).addClass("lang_" + langCode).addClass("translation");
        });
        $("#tokenTR" + obj.id).data("json", obj);
    }
    
    function updateTokens() {
        var context = $("#contexts").data("sel");
        if ("" == context) {
            $(".token").show();
        }
        else {
            // show selected context only
            $(".token").hide();
            $(".context_" + getSafe(context)).show();
        }
        
        // show selected language only
        var langCode = $("#languages").data("sel");
        $(".translation").hide();
        $(".lang_" + langCode).show();
    }
    
    function appendLanguage(obj, index) {
        if (obj.defaultLang) {
            $("#languagesBody")
                .append("<tr id=\"languageTR" + obj.langCode + "\"></tr>");
            $("#languageTR" + obj.langCode)
                .append("<td>" +
                "<input type=\"radio\" id=\"lang_" + obj.langCode + "\" name=\"language\" value=\"" + obj.langCode + "\" onChange=\"onLanguageChange(this.value);\" />" +
                "<label for=\"lang_" + obj.langCode + "\">"+ obj.langCode + " [" + obj.defaultLang.name + "]" + "</label>" +
                "</td>");
//            $("#languageTR" + obj.langCode).data("json", obj);
            
            $("#tileTokensHeader")
                .append('<th id="thTrans_' + obj.langCode + '">Translation (' + obj.langCode + ')</th>');
            $("#thTrans_" + obj.langCode).addClass("lang_" + obj.langCode).addClass("translation");
        }
        else {
            $("#langDefaultLabel").text(obj.langCode);
            $("#langDefault").val(obj.langCode);
            
            $("#thTrans").text("Translation (" + obj.langCode + ")");
            $("#thTrans").addClass("lang_" + obj.langCode).addClass("translation");
        }
    }
    
    function onLanguageChange(langCode) {
        $("#languages").data("sel", langCode);
        updateTokens();
    }

function buildProjectTiles(p) {
    $.map(p.contexts, function(c, index) {
        appendContext(c, index);
    });
    $.map(p.tokens, function(t, index) {
        appendToken(t, index, p.defProjLang, p.projLangs);
    });
    $.map(p.projLangs, function(l, index) {
        appendLanguage(l, index);
    });
}

$(function() {
    var p = $("#headerProject").data("json");

    $("#contexts").data("sel", "");
    $("#languages").data("sel", p.defProjLang.langCode);

    buildProjectTiles(p);
    updateTokens();
});

//    $(function() {
//        var projectName = $("#headerProject").text();
//        var p = $("#headerProject").data("project");
//        
//        // populate contexts
//        $.map(p.contexts, appendContext);
//        
//        // update default language
//        $("#langDefault").val(p.defProjLang.langCode);
//        $("#langDefault").attr("id", "lang_" + p.defProjLang.langCode);
//        $("#langDefaultLabel").text(p.defProjLang.langCode);
//        $("#langDefaultLabel").attr("for", "lang_" + p.defProjLang.langCode);
//        $("#languageTRdefault").attr("id", "languageTR" + p.defProjLang.langCode);
//        $("#languageTR" + p.defProjLang.langCode).data("json", p.defProjLang);
//        
//        // populate languages
//        $.map(p.projLangs, appendLanguage);
//    
//        $.ajax({
//            async: false,
//            type: "GET",
//            url: "/api/project/v10/" + p.name + "/token",
//            dataType: "json",
//            success: function(data){
//                $("#tokensBody").data("json", data);
//                updateTokens();
//            },
//            error: function(req, textStatus, errorThrown) {}
//        });        
//    });

</script>
